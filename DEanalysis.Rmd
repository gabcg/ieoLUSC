---
output:
  BiocStyle::html_document
---

<!---
Because we split the analysis pipeline in different independent files, to speed up processing it, here in the setup block we load libraries and objects that were loaded or produced in the previously processed file, and which are necessary in this file.
--->

```{r setup, cache=FALSE, echo=FALSE, results='hide', message=FALSE}
library(knitr)
library(SummarizedExperiment)
library(edgeR)
library(geneplotter)
opts_chunk$set(cache=TRUE,
               cache.path="cache/file2",
               cache.extra=R.version.string,
               autodep=TRUE,
               fig.align="center",
               comment="")
se.unpaired <- readRDS(file.path("rawCounts", "seLUSC.rds"))
dg.unpaired <- readRDS(file.path("results", "dge.rds"))
se <- readRDS(file.path("results", "se.paired.rds"))
dge <- readRDS(file.path("results", "dge.paired.rds"))
se.filt.unnorm <- readRDS(file.path("results", "se.paired.filt.unnorm.rds"))
dge.filt.unnorm <- readRDS(file.path("results", "dge.paired.filt.unnorm.rds"))
se.filt <- readRDS(file.path("results", "se.paired.filt.rds"))
dge.filt <- readRDS(file.path("results", "dge.paired.filt.rds"))
```

# Differential expression

## Differential expression using limma-voom and SVA

We perform a simple examination of expression changes and their associated p-values using the R/Bioconductor package [sva](http://bioconductor.org/packages/sva).

In order to use the method, a matrix of the model, including adjustment variables, and a null model which only includes the adjustment variables have to be created. In our case there are no factors to adjust, so we give ~1 as the intercept term in the model. Also, as the design of the analysis is paired (both types of samples come from the same patient), we need to add an identifier of the patient to the model.

Even if no known sources of variation were found, we can use SVA to estimate surrogate variables and add them to the model. These variables represent the unknown variation of the data.

```{r, message=FALSE}
library(sva)
# Obtain the patient ID, as the analysis is paired
patientid <- substr(colnames(se.filt), 9, 12)
samplevial <- substr(colnames(se.filt), 14, 16)

# Build the model (mod) and null (mod0) matrices 
mod <- model.matrix(~type + patientid, data = colData(se.filt))
mod0 <- model.matrix(~1, data = colData(se.filt))

# Estimate surrogate variables
sv <- sva(assays(se.filt)$logCPM, mod = mod, mod0 = mod0)

#pv <- f.pvalue(assays(se.filt)$logCPM, mod, mod0)
#sum(p.adjust(pv, method="fdr") < 0.01)

# Add surrogates to the design matrix
len <- length(colnames(mod))
mod <- cbind(mod, sv$sv)
colnames(mod) <- c(colnames(mod)[1:len], paste0("SV", 1:sv$n))
v <- voom(dge.filt, mod, plot=TRUE)

fit <- lmFit(v, mod) # Fit the model with the voom weights
fit <- eBayes(fit) # Calculate moderated t-statistics
```

`sva` was able to estimate `r sv$n.sv` surrogate variables. Regarding the mean-variance plot obtained with `voom`, it shows the variance in the y axis and the mean of expression in the x axis for each gene, represented as a black dot. The red curve is fitted to the dots, and shows the trends in the data: increases in expression levels usually mean decreases in the variance, until a plateau is reached for highly expressed genes. We observe this behaviour in our plot. Moreover, the plot is also a diagnosis of filtering steps performed previously. The fact that there is not a drop in variance for the lower expression values indicates that the filtering threshold was good.

<!--Info about voom plot from https://f1000research.com/articles/5-1408, https://genomebiology.biomedcentral.com/articles/10.1186/gb-2014-15-2-r29 and https://stats.stackexchange.com/questions/160255/voom-mean-variance-trend-plot-how-to-interpret-the-plot-->

As we are performing multiple tests, the probability of type I errors (rejecting the null hypotheses when it is true). There are multiple statistical tools to decrease this errors, such as false discovery rate (FDR). This technique consists on defining an acceptable rate of type I errors (false discoveries). Here, we set a FDR of 0.05, which means that 5% of our rejections of the null hypothesis will be incorrect.

```{r}
FDRcutoff <- 0.05
res <- decideTests(fit, p.value = FDRcutoff)
summary(res)
```

Gene metadata such as the gene symbol and the chromosome can be added for an easier interpretation of the obtained statistics.

```{r}
# Get gene info...
genesmd <- data.frame(chr = as.character(seqnames(rowRanges(se.filt))), symbol = rowData(se.filt)[, 1], stringsAsFactors = FALSE)

# and add it to the results
fit$genes <- genesmd
tt <- topTable(fit, coef = 2, n = Inf)
head(tt, n = 20)
```

What we can see from this table is that the FDR-adjusted p-values are close to 1, so they are not significant. We can check how many genes can be considered differentially expressed under the `r FDRcutoff` FDR cuttoff.

```{r}
DEgenes <- rownames(tt)[tt$adj.P.Val < FDRcutoff]
length(DEgenes)
```

So our differential expression analysis results in `r length(rownames(tt)[tt$adj.P.Val < FDRcutoff]))` differentially expressed genes.

The results of a differential expression analysis can also be diagnosed with the distributions of raw p-values and moderated t-statistics.

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 2, 2))
hist(tt$P.Value, xlab = "Raw P-values", main = "", las = 1)
qqt(fit$t[, 2], df = fit$df.prior + fit$df.residual, main = "", pch = ".", cex = 3)
abline(0, 1, lwd = 2)
```

Under the null hypothesis, we would expect a flat distribution of p-values. *And I think that the fact that there is not a enrichment of the low p-values is good, as this would mean that we are getting false positives because of too much variation in the data, or others.*

Regarding the second plot, it represents the quantiles of our data sample against the theoretical distribution they should follow. The diagonal represents the null hypothesis.

I'M LEAVING THE COMMENT OF THIS TWO PLOTS UNTIL SOMEBODY TELLS ME WHAT THEY ACTUALLY MEAN

## Alternative differential expression analysis approaches

As said previously, adding surrogate variables adjust for unknown variation, which in practice would translate into an increased number of differentially expressed genes with respect to an analysis done without including estimated surrogate variables. But in some cases it is possible that the surrogate analysis captures not only non-biological effects, but also some biological variability that is important for the outcome. This is specially true when there is some sort of heterogeneity on the data, for example when there are (unknown) subgroups. This motivates the following analyses, in which modifications to the surrogate variables are performed. In these analyses, code that is identical to the first analysis is not displayed.

### Differential expression analysis without surrogate variable adjustment

```{r, message=FALSE}
# Obtain the patient ID, as the analysis is paired
patientid <- substr(colnames(se.filt), 9, 12)
samplevial <- substr(colnames(se.filt), 14, 16)

# Build the model (mod) and null (mod0) matrices 
mod <- model.matrix(~type + patientid, data = colData(se.filt))
mod0 <- model.matrix(~1, data = colData(se.filt))

v <- voom(dge.filt, mod, plot=TRUE)

fit <- lmFit(v, mod) # Fit the model with the voom weights
fit <- eBayes(fit) # Calculate moderated t-statistics
```

`sva` was able to estimate `r sv$n.sv` surrogate variables. COMMENT THE VOOM PLOT.

INTRODUCE FDR Here, we set a FDR of 0.05, which means that 5% of our rejections of the null hypothesis will be incorrect. Gene metadata such as the gene symbol and the chromosome can be added for an easier interpretation of the obtained statistics.

```{r echo=FALSE}
FDRcutoff <- 0.05
res <- decideTests(fit, p.value = FDRcutoff)
summary(res)
```


```{r echo=FALSE}
# Get gene info...
genesmd <- data.frame(chr = as.character(seqnames(rowRanges(se.filt))), symbol = rowData(se.filt)[, 1], stringsAsFactors = FALSE)

# and add it to the results
fit$genes <- genesmd
tt <- topTable(fit, coef = 2, n = Inf)
head(tt, n = 20)
```

REWRITE We see how the asjusted p-values have decreased. We can check how many genes can be considered differentially expressed under the `r FDRcutoff` FDR cuttoff.

```{r echo=FALSE}
DEgenes <- rownames(tt)[tt$adj.P.Val < FDRcutoff]
length(DEgenes)
```

REWRITE So our differential expression analysis results in `r length(rownames(tt)[tt$adj.P.Val < FDRcutoff]))` differentially expressed genes. We can check their chr distribution.

```{r}
sort(table(tt$chr[tt$adj.P.Val < FDRcutoff]), decreasing = TRUE)
plot(sort(table(tt$chr[tt$adj.P.Val < FDRcutoff]), decreasing = TRUE))
axis(side=1, cex.axis=0.35)
```

## DIAGNOSTICS

The results of differential expression analyses can also be diagnosed with the distributions of raw p-values and moderated t-statistics.

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 2, 2))
hist(tt$P.Value, xlab = "Raw P-values", main = "", las = 1)
qqt(fit$t[, 2], df = fit$df.prior + fit$df.residual, main = "", pch = ".", cex = 3)
abline(0, 1, lwd = 2)
```

COMMENT THOSE

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 3, 2))
volcanoplot(fit, coef = 2, highlight = 10, names = fit$genes$symbol, main = "Volcano")

top <- order(fit$lods[, 2], decreasing = TRUE)[1:10]
limma::plotMA(fit, coef = 2, status = rownames(fit$lods) %in% DEgenes, legend = FALSE,
main = "MA Plot", hl.pch = 46, hl.cex = 4, bg.pch = 46, bg.cex = 3, las = 1)
text(fit$Amean[top], fit$coef[top, 2], fit$genes$symbol[top], cex = 0.5, pos = 4)
```

The list of top 10 genes:

```{r}
fit$genes$symbol[top]
```

### Differential expression analysis removing the first surrogate variable

The removal of all the surrogate variables might be considered radical, as some of them might cature part of the unwanted variation which we want to adjust. As there was a possibility that only one of those variables contains biological variation, we decided to remove one by one each surrogate variable. We observed that with the first one, significant results were obtained, so we will show the analysis by removing this surrogate variable.

```{r, message=FALSE}
library(sva)
# Obtain the patient ID, as the analysis is paired
patientid <- substr(colnames(se.filt), 9, 12)
samplevial <- substr(colnames(se.filt), 14, 16)

# Build the model (mod) and null (mod0) matrices 
mod <- model.matrix(~type + patientid, data = colData(se.filt))
mod0 <- model.matrix(~1, data = colData(se.filt))

# Estimate surrogate variables
sv <- sva(assays(se.filt)$logCPM, mod = mod, mod0 = mod0)

# Remove the first surrogate variable
svmod <- sv$sv[,-1]

# Add surrogates to the design matrix
len <- length(colnames(mod))
mod <- cbind(mod, svmod)
colnames(mod) <- c(colnames(mod)[1:len], paste0("SV", 1:(sv$n-1)))
v <- voom(dge.filt, mod, plot=TRUE)

fit <- lmFit(v, mod) # Fit the model with the voom weights
fit <- eBayes(fit) # Calculate moderated t-statistics
```

`sva` was able to estimate `r sv$n.sv` surrogate variables. The mean-variance plot obtained with `voom`, is similar to the one done with all the surrogate variables.

Next, we set a a FDR of 0.05 and get some preliminary results, and later we add the gene metadata.

```{r echo=FALSE}
FDRcutoff <- 0.05
res <- decideTests(fit, p.value = FDRcutoff)
summary(res)
```

```{r echo=FALSE}
# Get gene info...
genesmd <- data.frame(chr = as.character(seqnames(rowRanges(se.filt))), symbol = rowData(se.filt)[, 1], stringsAsFactors = FALSE)

# and add it to the results
fit$genes <- genesmd
tt <- topTable(fit, coef = 2, n = Inf)
head(tt, n = 20)
```

We already see how the adjusted p-values are smaller, leading to significant expression changes. Again, we check how many genes are considered differentially expressed under the `r FDRcutoff` FDR cuttoff.

```{r echo=FALSE}
DEgenes <- rownames(tt)[tt$adj.P.Val < FDRcutoff]
length(DEgenes)
```

So the differential expression analysis without the first surrogate variable results in `r length(rownames(tt)[tt$adj.P.Val < FDRcutoff]))` differentially expressed genes. Their chromosome distribution can be assessed.

```{r}
sort(table(tt$chr[tt$adj.P.Val < FDRcutoff]), decreasing = TRUE)
plot(sort(table(tt$chr[tt$adj.P.Val < FDRcutoff]), decreasing = TRUE))
axis(side=1, cex.axis=0.35)
```

#### Diagnostics

The results of a differential expression analysis can also be diagnosed with the distributions of raw p-values and moderated t-statistics.

```{r echo=FALSE}
par(mfrow = c(1, 2), mar = c(4, 5, 2, 2))
hist(tt$P.Value, xlab = "Raw P-values", main = "", las = 1)
qqt(fit$t[, 2], df = fit$df.prior + fit$df.residual, main = "", pch = ".", cex = 3)
abline(0, 1, lwd = 2)
```

We observe that the assumption of a flat distribution of raw p-values for the non-DE genes under the null hypothesis holds in this case. We also observe in the QQ plot how the DE genes are far from the null hypothesis.

ALSO KKKKAKAKAKAKKAJHJAGJFUGHT

```{r}
par(mfrow = c(1, 2), mar = c(4, 5, 3, 2))
volcanoplot(fit, coef = 2, highlight = 10, names = fit$genes$symbol, main = "Volcano")

top <- order(fit$lods[, 2], decreasing = TRUE)[1:10]
limma::plotMA(fit, coef = 2, status = rownames(fit$lods) %in% DEgenes, legend = FALSE,
main = "MA Plot", hl.pch = 46, hl.cex = 4, bg.pch = 46, bg.cex = 3, las = 1)
text(fit$Amean[top], fit$coef[top, 2], fit$genes$symbol[top], cex = 0.5, pos = 4)
```

The list of top 10 genes:

```{r}
fit$genes$symbol[top]
```

### Performance comparison

```{r}

```




-----------------------------------------------------------
There are `r sum(p.adjust(pv, method="fdr") < 0.01)` genes changing significantly their expression at FDR < 1%. In Figure \@ref(fig:pdist) below we show the distribution of the resulting p-values. This distribution should be uniform with a peak at low p-values for the truly DE genes, assuming that most genes are not differentially expressed.

```{r pdist, echo=FALSE, out.width="800px", fig.cap="Distribution of raw p-values for an F-test on every gene between tumor and normal samples."}


```

The `sva()` function is able to estimate surrogate variables, which have continuous values that can be used to correct and adjust unmeasured and unwanted effects.

```{r}
```

The SVA algorithm has found `r sv$n` surrogate variables. Let's use them to assess againt the extent of differential expression this time adjusting for these surrogate variables.

```{r}

```

We have increased the number of changing genes to `r sum(p.adjust(pvsv, method="fdr") < 0.01)`. Figure \@ref(fig:psvdist) shows the resulting distribution of p-values.

```{r psvdist, echo=FALSE, out.width="800px", fig.cap="Distribution of raw p-values for an F-test on every gene between tumor and normal samples, adjusting for surrogate variables estimated with SVA."}

```

## Session information

```{r, message=FALSE}
sessionInfo()
```
